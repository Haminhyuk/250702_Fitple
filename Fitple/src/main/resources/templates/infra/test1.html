<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>장소 검색하기</title>
  <style>
  </style>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="/css/infraCSS.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>
<h1> 주변 생활권 정보</h1>
<select id="sidoSelect">
  <option value="">시/도 선택</option>
</select>
<select id="sigunguSelect">
  <option value="">시/군/구 선택</option>
</select>
<input type="text" id="Pkeyword" placeholder="지역명을 입력하세요">
<button onclick="searchAddress()">검색</button>
<input type="text" id="keyword" placeholder="장소 검색하기" />
<div class="map_wrap">
  <div id="map" style="width:100%;height:100%;position:relative;overflow:hidden;"></div>
  <ul id="category">
    <li id="SW8" data-order="0">
      <span class="fas fa-subway"></span>
      지하철
    </li>
    <li id="MT1" data-order="1">
      <span class="fas fa-store-alt"></span>
      마트
    </li>
    <li id="HP8" data-order="2">
      <span class="fas fa-hospital"></span>
      병원
    </li>
    <li id="PM9" data-order="3">
      <span class="fas fa-pills"></span>
      약국
    </li>
    <li id="CE7" data-order="4">
      <span class="fas fa-coffee"></span>
      카페
    </li>
    <li id="CS2" data-order="5">
      <span class="fas fa-store"></span>
      편의점
    </li>
  </ul>
</div>
<div id="resultWrapper">
  <div id="resultCount"></div>
  <ul id="placesList"></ul>
  <div id="pagination"></div>
</div>
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=b8731ae4d4303ec9f32c926ed947ae8d&libraries=services"></script>




<script>
  // 커스텀 오버레이를 위한 객체 생성
  var placeOverlay = new kakao.maps.CustomOverlay({ zIndex: 1 }),
          contentNode = document.createElement('div'), // 커스텀 오버레이에 표시할 내용
          markers = [],              // 지도에 표시된 마커들을 담는 배열
          currCategory = '',         // 현재 선택된 카테고리 코드 (예: 'CE7' = 카페)
          currKeyword = '';          // 현재 입력된 키워드 문자열

  // 지도 생성
  const mapContainer = document.getElementById('map');
  const map = new kakao.maps.Map(mapContainer, {
    center: new kakao.maps.LatLng(37.566826, 126.9786567),
    level: 7
  });
  // var map = new kakao.maps.Map(mapContainer, mapOption); // 지도 객체 생성

  // 장소 검색 서비스 객체 생성
  var ps = new kakao.maps.services.Places(map);

  // 지도 상태가 바뀌었을 때 (idle), 검색 실행
  // kakao.maps.event.addListener(map, 'idle', searchPlaces);

  // 커스텀 오버레이 스타일 및 이벤트 등록
  contentNode.className = 'placeinfo_wrap';
  addEventHandle(contentNode, 'mousedown', kakao.maps.event.preventMap);
  addEventHandle(contentNode, 'touchstart', kakao.maps.event.preventMap);
  placeOverlay.setContent(contentNode);

  // 카테고리 버튼에 이벤트 연결
  addCategoryClickEvent();

  // 이벤트 핸들러 등록 함수 (브라우저 호환용)
  function addEventHandle(target, type, callback) {
    if (target.addEventListener) {
      target.addEventListener(type, callback);
    } else {
      target.attachEvent('on' + type, callback);
    }
  }

  // 키워드 기반 장소 검색
  function searchKeywordPlaces(keyword) {
    if (!keyword.trim()) return; // 공백이면 무시
    placeOverlay.setMap(null);
    removeMarker();

    ps.keywordSearch(keyword, placesSearchCB, { useMapBounds: true }); // 지도 범위 내 검색
  }

  // 카테고리 또는 키워드에 따라 검색
  function searchPlaces() {
    if (currKeyword) {
      searchKeywordPlaces(currKeyword); // 키워드가 있으면 키워드 우선
      return;
    }

    if (!currCategory && !currKeyword) return;

    placeOverlay.setMap(null);
    removeMarker();

    ps.categorySearch(currCategory, placesSearchCB, { useMapBounds: true });
  }
  //
  // // 검색 결과 콜백 함수
  // function placesSearchCB(data, status, pagination) {
  //   if (status === kakao.maps.services.Status.OK) {
  //     displayPlaces(data); // 성공 시 결과 표시
  //   } else{
  //     console.error("❌ 검색 실패 상태:", status);
  //   }
  // }

  // 장소 리스트와 마커 표시
  function displayPlaces(places) {
    var listEl = document.getElementById('placesList');
    listEl.innerHTML = ''; // 기존 리스트 초기화

    document.getElementById('resultCount').innerText = `총 ${places.length}개 장소`;

    var useDefaultMarker = !currCategory; // 카테고리 없으면 기본 마커 사용
    var order = '';

    if (currCategory) {
      order = document.getElementById(currCategory).getAttribute('data-order');
    }

    for (var i = 0; i < places.length; i++) {
      // 마커 생성
      var marker = addMarker(new kakao.maps.LatLng(places[i].y, places[i].x), order, useDefaultMarker);

      // 리스트 항목 생성
      var itemEl = document.createElement('li');
      itemEl.innerHTML = `<strong>${places[i].place_name}</strong><br>${places[i].address_name}`;
      listEl.appendChild(itemEl);

      // 마커 클릭 및 리스트 클릭 시 오버레이 표시
      (function (marker, place, listItem) {
        kakao.maps.event.addListener(marker, 'click', function () {
          displayPlaceInfo(place);
          highlightListItem(listItem);
        });



        listItem.onclick = function () {
          kakao.maps.event.trigger(marker, 'click');
          map.panTo(marker.getPosition());
          document.getElementById('map').scrollIntoView({ behavior: 'smooth' });

        };
      })(marker, places[i], itemEl);
    }
  }

  // 마커 추가 함수 (기본 마커 or 커스텀 아이콘)
  function addMarker(position, order, useDefaultMarker) {
    var marker = new kakao.maps.Marker({
      position: position
    });
    marker.setMap(map);
    markers.push(marker);
    return marker;
    }

  // 기존 마커 전부 제거
  function removeMarker() {
    for (var i = 0; i < markers.length; i++) {
      markers[i].setMap(null);
    }
    markers = [];
  }

  // 장소 정보 오버레이 표시
  function displayPlaceInfo(place) {
    var content = '<div class="placeinfo">' +
            `<a class="title" href="${place.place_url}" target="_blank">${place.place_name}</a>`;

    if (place.road_address_name) {
      content += `<span>${place.road_address_name}</span><span class="jibun">(지번: ${place.address_name})</span>`;
    } else {
      content += `<span>${place.address_name}</span>`;
    }

    content += `<span class="tel">${place.phone}</span></div><div class="after"></div>`;

    contentNode.innerHTML = content;
    placeOverlay.setPosition(new kakao.maps.LatLng(place.y, place.x));
    placeOverlay.setMap(map);
  }

  // 리스트 항목 강조 표시
  function highlightListItem(el) {
    let items = document.querySelectorAll('#placesList li');
    items.forEach(item => item.classList.remove('selected'));
    el.classList.add('selected');
  }

  // 카테고리 버튼 이벤트 등록
  function addCategoryClickEvent() {
    var category = document.getElementById('category'),
            children = category.children;

    for (var i = 0; i < children.length; i++) {
      children[i].onclick = onClickCategory;
    }
  }

  // 카테고리 클릭 시 처리
  function onClickCategory() {
    var id = this.id,
            className = this.className;

    placeOverlay.setMap(null);

    if (className === 'on') {
      currCategory = '';
      changeCategoryClass();
      removeMarker();
    } else {
      currCategory = id;
      currKeyword = ''; // 키워드 초기화
      document.getElementById('keyword').value = '';
      changeCategoryClass(this);
      searchPlaces();
    }
  }

  // 선택된 카테고리만 'on' 클래스 적용
  function changeCategoryClass(el) {
    var category = document.getElementById('category'),
            children = category.children;

    for (var i = 0; i < children.length; i++) {
      children[i].className = '';
    }

    if (el) {
      el.className = 'on';
    }
  }

  // 키워드 검색창: 엔터 키 입력 처리
  document.getElementById('keyword').addEventListener('keydown', function (e) {


    if (e.key === 'Enter') {
      e.preventDefault();

      if(!this.value.trim()) {
        alert("장소명을 입력하세요");
        return;
      }
      currKeyword = this.value;          // 입력값 저장
      currCategory = '';                 // 카테고리 선택 해제
      changeCategoryClass();             // 버튼 스타일 초기화
      searchPlaces();                    // 키워드 검색 실행
    }
  });

</script>
<script>
  function placesSearchCB(data, status, pagination) {
    if (status === kakao.maps.services.Status.OK) {
      if (data.length === 0) {
        document.getElementById('placesList').innerHTML = '';
        document.getElementById('resultCount').innerText = '검색 결과가 없습니다.';
        document.getElementById('pagination').innerHTML = '';
        removeMarker();
        placeOverlay.setMap(null);
        return;
      }
      displayPlaces(data);
      displayPagination(pagination);
    } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
      document.getElementById('placesList').innerHTML = '';
      document.getElementById('resultCount').innerText = '검색 결과가 없습니다.';
      document.getElementById('pagination').innerHTML = '';
      removeMarker();
      placeOverlay.setMap(null);
    } else {
      alert('장소 검색 중 오류가 발생했습니다.');
      console.error("❌ 검색 실패 상태:", status);
    }
  }

  function displayPagination(pagination) {
    const paginationEl = document.getElementById('pagination');
    paginationEl.innerHTML = ''; // 이전 페이지 버튼들 제거

    const fragment = document.createDocumentFragment();

    for (let i = 1; i <= pagination.last; i++) {
      const page = document.createElement('a');
      page.href = '#';
      page.innerText = i;

      if (i === pagination.current) {
        page.className = 'on'; // 현재 페이지 강조
      } else {
        page.onclick = (function (i) {
          return function () {
            pagination.gotoPage(i); // i번째 페이지 이동
          };
        })(i);
      }

      fragment.appendChild(page);
    }

    paginationEl.appendChild(fragment);
  }
</script>
<script>
  var geocoder = new kakao.maps.services.Geocoder();

  function searchAddress() {

    const Pkeyword = document.getElementById('Pkeyword').value.trim();

    if (!Pkeyword) {
      alert("지역명을 입력하세요.");
      return;
    }


    geocoder.addressSearch(Pkeyword, function(result, status) {
      if (status === kakao.maps.services.Status.OK) {
        var coords = new kakao.maps.LatLng(result[0].y, result[0].x);

        map.setCenter(coords);  // 지도 중심 이동
        map.setLevel(3);        // 확대 레벨 조절


        // 단지 지도 중심이 바뀌었으니, 기존 키워드가 있다면 해당 키워드로 새 지역 범위 내 재검색 실행
        if (currKeyword && currKeyword.trim() !== '') {
          searchKeywordPlaces(currKeyword); // 새 위치 기준 키워드 검색
        } else if (currCategory) {
          searchPlaces(); // 카테고리 검색 재실행
        } else {
          // 키워드 없고 카테고리 없으면 검색 안함
          removeMarker();
          placeOverlay.setMap(null);
          document.getElementById('placesList').innerHTML = '';
          document.getElementById('resultCount').innerText = '';
          document.getElementById('pagination').innerHTML = '';
        }

      } else {
        alert("해당 지역을 찾을 수 없습니다.");
        currKeyword = '';
        return;
      }
    });
  }
</script>
<script>
  let polygon = null; // 이전에 그린 폴리곤 저장용

  document.getElementById('sigunguSelect').addEventListener('change', function () {
    const sigCd = this.value;

    if (!sigCd) return;

    // 폴리곤이 이미 있으면 제거
    if (polygon) {
      polygon.setMap(null);
      polygon = null;
    }

    fetch(`/api/polygon?sigCd=${sigCd}`)
            .then(res => res.json())
            .then(data => {
              // VWorld에서 좌표 데이터가 features 배열 내 geometry.coordinates로 옴
              const features = data.response?.result?.featureCollection?.features;

              if (!features || features.length === 0) {
                alert("해당 지역 데이터가 없습니다.");
                return;
              }

              // 좌표 배열 (폴리곤은 다중배열)
              const coords = features[0].geometry.coordinates;

              // Kakao Map에 맞게 LatLng 배열 변환 (lng, lat) → (lat, lng)
              // 다중 폴리곤 지원 - features[0].geometry.type == "MultiPolygon" or "Polygon"
              // VWorld API의 좌표 구조 확인 후 조정 필요
              let paths = [];

              if (features[0].geometry.type === "MultiPolygon") {
                coords.forEach(polygonCoords => {
                  polygonCoords.forEach(ring => {
                    const path = ring.map(([lng, lat]) => new kakao.maps.LatLng(lat, lng));
                    paths.push(path);
                  });
                });
              } else if (features[0].geometry.type === "Polygon") {
                coords.forEach(ring => {
                  const path = ring.map(([lng, lat]) => new kakao.maps.LatLng(lat, lng));
                  paths.push(path);
                });
              } else {
                alert("폴리곤 데이터가 아닙니다.");
                return;
              }
              // 중심 맞추기
              function getPolygonCenter(paths) {
                let sumLat = 0, sumLng = 0, count = 0;
                paths.forEach(path => {
                  path.forEach(latlng => {
                    sumLat += latlng.getLat();
                    sumLng += latlng.getLng();
                    count++;
                  });
                });
                return new kakao.maps.LatLng(sumLat / count, sumLng / count);
              }

              // 지도 중심 이동 (첫 좌표 기준)
              const center = getPolygonCenter(paths);
              map.setCenter(center);
              map.setLevel(5);

              // 폴리곤 생성 및 지도에 표시
              polygon = new kakao.maps.Polygon({
                map: map,
                path: paths,
                strokeWeight: 3,
                strokeColor: '#004c80',
                strokeOpacity: 0.5,
                fillColor: '#00a0e9',
                fillOpacity: 0.1
              });
            })
            .catch(err => {
              console.error(err);
              alert("폴리곤 데이터를 불러오는 중 오류가 발생했습니다.");
            });
  });
</script>
<script>
  function updatePolygonByKeyword(keyword) {
    // 백엔드에서 keyword → sigCd 변환 API가 있어야 함
    fetch(`/api/sigCdByName?keyword=${encodeURIComponent(keyword)}`)
            .then(res => res.json())
            .then(data => {
              const sigCd = data.sigCd;
              if (!sigCd) {
                alert("해당 지역의 행정구역 코드를 찾을 수 없습니다.");
                return;
              }

              // 기존 polygon 지우기
              if (polygon) {
                polygon.setMap(null);
                polygon = null;
              }

              // 폴리곤 API 호출
              fetch(`/api/polygon?sigCd=${sigCd}`)
                      .then(res => res.json())
                      .then(data => {
                        const features = data.response?.result?.featureCollection?.features;
                        if (!features || features.length === 0) {
                          alert("해당 지역 데이터가 없습니다.");
                          return;
                        }

                        const coords = features[0].geometry.coordinates;
                        let paths = [];

                        if (features[0].geometry.type === "MultiPolygon") {
                          coords.forEach(polygonCoords => {
                            polygonCoords.forEach(ring => {
                              const path = ring.map(([lng, lat]) => new kakao.maps.LatLng(lat, lng));
                              paths.push(path);
                            });
                          });
                        } else if (features[0].geometry.type === "Polygon") {
                          coords.forEach(ring => {
                            const path = ring.map(([lng, lat]) => new kakao.maps.LatLng(lat, lng));
                            paths.push(path);
                          });
                        }

                        // 중심 이동
                        const center = getPolygonCenter(paths);
                        map.setCenter(center);
                        map.setLevel(4);

                        // 폴리곤 표시
                        polygon = new kakao.maps.Polygon({
                          map: map,
                          path: paths,
                          strokeWeight: 3,
                          strokeColor: '#004c80',
                          strokeOpacity: 0.8,
                          fillColor: '#00a0e9',
                          fillOpacity: 0.3
                        });
                      });
            })
            .catch(err => {
              console.error(err);
              alert("행정구역 정보 또는 폴리곤 로딩에 실패했습니다.");
            });
  }

  // 중심 좌표 구하는 함수
  function getPolygonCenter(paths) {
    let sumLat = 0, sumLng = 0, count = 0;
    paths.forEach(path => {
      path.forEach(latlng => {
        sumLat += latlng.getLat();
        sumLng += latlng.getLng();
        count++;
      });
    });
    return new kakao.maps.LatLng(sumLat / count, sumLng / count);
  }
</script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const sidoSelect = document.getElementById("sidoSelect");
    const sigunguSelect = document.getElementById("sigunguSelect");
    const keywordInput = document.getElementById("Pkeyword");

    // 🔹 시도 가져오기
    fetch("/api/sido")
            .then(res => res.json())
            .then(data => {
              const features = data.response.result.featureCollection.features;
              const sidoList = features.map(f => ({
                code: f.properties.ctprvn_cd,
                name: f.properties.ctp_kor_nm
              }));

              sidoList.forEach(sido => {
                const option = document.createElement("option");
                option.value = sido.code;
                option.textContent = sido.name;
                sidoSelect.appendChild(option);
              });
            });

    // 🔹 시도 선택 → 시군구 로딩
    sidoSelect.addEventListener("change", function () {
      const sidoCd = this.value;
      sigunguSelect.innerHTML = "<option value=''>시/군/구 선택</option>";

      if (!sidoCd) {
        keywordInput.value = "";
        return;
      }

      fetch(`/api/sigungu?sidoCd=${sidoCd}`)
              .then(res => res.json())
              .then(data => {
                const features = data.response.result.featureCollection.features;
                const sigunguList = features.map(f => ({
                  code: f.properties.sig_cd,
                  name: f.properties.sig_kor_nm
                }));

                sigunguList.forEach(sig => {
                  const option = document.createElement("option");
                  option.value = sig.code;
                  option.textContent = sig.name;
                  sigunguSelect.appendChild(option);
                });
              });

      // 시도만 선택된 경우에도 키워드 반영
      keywordInput.value = this.options[this.selectedIndex].text;
    });

    // 🔹 시군구 선택 → 키워드 자동 입력 + 검색 실행
    sigunguSelect.addEventListener("change", function () {
      const sidoText = sidoSelect.options[sidoSelect.selectedIndex].text;
      const sigunguText = this.options[this.selectedIndex].text;

      if (sidoText && sigunguText) {
        keywordInput.value = `${sidoText} ${sigunguText}`;
        searchAddress(); // 자동 검색 실행
      }
    });

    // 🔹 검색창에서 Enter 누르면 수동 검색
    keywordInput.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        e.preventDefault();
        searchAddress();
      }
    });
  });
</script>
</body>
</html>